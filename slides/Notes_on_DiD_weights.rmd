---
title: "A few notes about decomposing the two way fixed effects estimator"
author: "By Hans H. Sievertsen (h.h.sievertsen@bristol.ac.uk)"
date: 'This version: 05/06/2020; [link to most recent version](https://github.com/hhsievertsen/twowayfedecomp/raw/master/slides/Notes_on_DiD_weights.pdf)'
output:
  slidy_presentation: default
  beamer_presentation: default
theme: metropolis
latex_engine: xelatex
fontsize: 8pt
---

```{r , include=FALSE, echo=FALSE}
#theme: metropolis
#latex_engine: xelatex
#output: beamer_presentation
```

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache = TRUE)
library("tidyverse")
library("ggpubr")
library("bacondecomp")
library("lfe")
library("patchwork")
```

```{r c1,  include=FALSE, echo=FALSE}
# Simulate data
simulate_data<-function(seed,T2,T3,m2,m3,mt2,mt3,G2,G3){
  # set values
  set.seed(seed)                        # set seed
  mt2=(1+mt2)                           # Treatment effect growth group 2
  mt3=(1+mt3)                           # Treatment effect growth group 3
  m2=1+m2                               # Treatment effect group 2
  m3=1+m3                               # Treatment effect group 3
  T<-50                                 # Time periods
  G<-3                                  # Groups
  G1<-30                                # Group size group 1 (never treated)
  N<-G1+G2+G3   
  # Create tibble
  df<-tibble(id=rep(1:(N),T),                                     # Id variable 1 2 3 ... 1 2 3 
             t=rep(1:T,each=(N)))%>%                              # Time variable 1 1 1 1 .... 2 2 2
      mutate(G=ifelse(id<=G1,1,ifelse(id>G1&id<=(G1+G2),2,3)),    # Treated: D==1
             D=ifelse(G==2&t>=T2,1,ifelse(G==3&t>=T3,1,0)),         # Post treatment indicator 
             mean=ifelse(D==1&G==2,m2*mt2^(t-T2),                 # Treatment effect group 2 
                  ifelse(D==1&G==3,m3*mt3^(t-T3),                 # Treatment effect group 3
                              1)),                                # mean Y for untreated
              y=rnorm(n=N*T,mean=mean,sd=.1))%>%                  # Simulate Outcome y
    group_by(G,D)%>%                                              # Group by "group times post" treatment
    mutate(ybar=mean(y))                                          # Group means for chart
  return(df)
}
df<-simulate_data(42,10,20,1,2,0,0,30,30)
```



# What is this?

**Objective**

- Introduce the Chaisemartin & D'Haultfoeuille (forthcoming, AER; CD)  & Goodman-Bacon (2019 WP; GB) decomposition of the two way fixed effects estimator and link them.
\vspace{20pt}

**Disclaimer**

- The slides represent my understanding. It might be wrong and there will be mistakesg. Please let me know. 
- There is **a lot** more in CD's and GB's papers.
- I don't discuss assumptions (!) and extensions. 
- Please see the original papers.

# The traditional difference-in-differences (DD)

The running example

```{r c2, echo = FALSE,fig.width=3,fig.height=2,fig.align="center"}
ggplot(df%>%filter(G!=3))+geom_jitter(aes(x=t,y=y,colour=as.factor(G)),size=.8,alpha=0.2)+theme_classic()+ theme(legend.position="top")+
  labs(x="t",y="y",colour="g") +scale_color_manual(values=c("#999999", "#E69F00", "#56B4E9"))+ylim(0,4)+
   theme(axis.ticks = element_blank(),plot.background = element_rect(fill="#FAFAFA",colour = "#FAFAFA"),
         text = element_text(size=5),legend.background = element_rect(fill="#FAFAFA",colour = "#FAFAFA"),
         panel.background = element_rect(fill = "#FAFAFA"),legend.margin=margin(b=-10),legend.box.margin=margin(0,0,0,0))+
   geom_vline(xintercept = 10, linetype="dashed", color = "gray", size=0.5)
  
```

- $t$: period, $g$: group, $y$: outcome, $d$: treatment indicator,  $g=1$ is never treated, $g=2$ is treated from $t=10$.

## The traditional DD

```{r c3, echo = FALSE,fig.width=3,fig.height=2,fig.align="center"}
ggplot(df%>%filter(G!=3))+geom_step(aes(x=t,y=ybar,colour=as.factor(G)),size=1)+theme_classic()+ theme(legend.position="top")+
  labs(x="t",y="y",colour="g") +scale_color_manual(values=c("#999999", "#E69F00", "#56B4E9"))+ylim(0,4)+
   theme(axis.ticks = element_blank(),plot.background = element_rect(fill="#FAFAFA",colour = "#FAFAFA"),
         text = element_text(size=5),legend.background = element_rect(fill="#FAFAFA",colour = "#FAFAFA"),
         panel.background = element_rect(fill = "#FAFAFA"),legend.margin=margin(b=-10),legend.box.margin=margin(0,0,0,0))+
   geom_vline(xintercept = 10, linetype="dashed", color = "gray", size=0.5)
  
```

- $t$: period, $g$: group, $y$: outcome, $d$: treatment indicator,  $g=1$ is never treated, $g=2$ is treated from $t=10$.
- DD estimate: 
\begin{equation}\hat{\beta}^{DD}=(\bar{Y}_{g=2,t\geq 10}-\bar{Y}_{g=2,t<10})-(\bar{Y}_{g=1,t\geq 10}-\bar{Y}_{g=1,t<10})
\end{equation}

- As seen in for example *Card & Krueger (1994) "Minimum Wages and Employment: A Case Study of the Fast
Food Industry in New Jersey and Pennsylvania", AER, 84, 772-784.*

## DD with more groups

```{r c4, echo = FALSE,fig.width=3,fig.height=2,fig.align="center"}
ggplot(df)+geom_step(aes(x=t,y=ybar,colour=as.factor(G)),size=1)+theme_classic()+ theme(legend.position="top")+
  labs(x="t",y="y",colour="g") +scale_color_manual(values=c("#999999", "#E69F00", "#56B4E9"))+ylim(0,4)+
   theme(axis.ticks = element_blank(),plot.background = element_rect(fill="#FAFAFA",colour = "#FAFAFA"),
         text = element_text(size=5),legend.background = element_rect(fill="#FAFAFA",colour = "#FAFAFA"),
         panel.background = element_rect(fill = "#FAFAFA"),legend.margin=margin(b=-10),legend.box.margin=margin(0,0,0,0))+
   geom_vline(xintercept = 10, linetype="dashed", color = "gray", size=0.5)+
  geom_vline(xintercept = 20, linetype="dashed", color = "gray", size=0.5)
  
```

- Add another group,  $g=3$ that gets treated from period $t=20$.

- DD estimate is then often estimated as $\hat{\beta}_{fe}$ from an OLS regression of: 
\begin{equation}y_{i,g,t}=\alpha+\gamma' G_{g}+\psi' T_{t}+ \beta_{fe} D_{g,t}+e_{i,g,t}\end{equation}
- $\beta_{fe}$ is also called the two-way FE estimator (we have both group and period fixed effects).


## What  $\beta_{fe}$ capturing and how does it relate to $\hat{\beta}^{DD}$ ?

**Bit question: What is ${\beta}_{fe}$ capturing?**
\vspace{15pt}
  
- *Chaisemartin & D'Haultfoeuille (CD): "Two-way fixed effects estimators with heterogeneous treatment effects" (forthcoming, AER)*

  - **Decomposition of $\hat{\beta}_{fe}$  in weighted ATEs across $(t,g)$ cells.**
  - Applicable to 2-way (e.g., group & time) fixed effects approaches.

\vspace{15pt}
  
- *Goodman-Bacon (GB): "Difference-in-Differences with Variation in Treatment Timing" (2019, WP)*

  - **Decomposition of $\hat{\beta}_{fe}$  in weighted $\hat{\beta}^{DD}$s**
  - Applicable to staggered adoptation designs.
  
- (There are other papers.)

**Let's start with the GB approach**

## The GB decomposition

- We consider the example with 3 groups and a staggered introduction of a policy: 
```{r c5, echo = FALSE,fig.width=2.5,fig.height=1.5,fig.align="center"}
ggplot(df)+geom_step(aes(x=t,y=ybar,colour=as.factor(G)),size=1)+theme_classic()+ theme(legend.position="top")+
  labs(x="t",y="y",colour="g") +scale_color_manual(values=c("#999999", "#E69F00", "#56B4E9"))+ylim(0,4)+
   theme(axis.ticks = element_blank(),plot.background = element_rect(fill="#FAFAFA",colour = "#FAFAFA"),
         text = element_text(size=5),legend.background = element_rect(fill="#FAFAFA",colour = "#FAFAFA"),
         panel.background = element_rect(fill = "#FAFAFA"),legend.margin=margin(b=-10),legend.box.margin=margin(0,0,0,0))+
   geom_vline(xintercept = 10, linetype="dashed", color = "gray", size=0.5)+
  geom_vline(xintercept = 20, linetype="dashed", color = "gray", size=0.5)
  
```

- Goodman-Bacon:  we can decompose this in 4 separate $\hat{\beta}^{DD}$:

\vspace{12pt}

```{r c6, echo = FALSE,fig.width=5,fig.height=2}

bp<-ggplot(df)+theme_classic()+ theme(legend.position="top")+
  labs(x="t",y="y",colour="g") +xlim(0,50)+ylim(0,4)+
   theme(axis.ticks = element_blank(),plot.background = element_rect(fill="#FAFAFA",colour = "#FAFAFA"),
         text = element_text(size=4),legend.background = element_rect(fill="#FAFAFA",colour = "#FAFAFA"),plot.title = element_text(hjust = 0.5),
         panel.background = element_rect(fill = "#FAFAFA"),legend.margin=margin(b=-10),legend.box.margin=margin(0,0,0,0))
   

a<-bp+geom_step(data=df%>%filter(G!=3),mapping=aes(x=t,y=ybar,colour=as.factor(G)),size=.5)+
    geom_vline(xintercept = 10, linetype="dashed", color = "gray", size=0.25)+
  scale_color_manual(values=c("#999999", "#E69F00", "#56B4E9"))
b<-bp+geom_step(data=df%>%filter(G!=2),mapping=aes(x=t,y=ybar,colour=as.factor(G)),size=.5)+
    geom_vline(xintercept = 20, linetype="dashed", color = "gray", size=0.25)+
     scale_color_manual(values=c("#999999",  "#56B4E9"))
c<-bp+geom_step(data=df%>%filter(G!=1,t<20),mapping=aes(x=t,y=ybar,colour=as.factor(G)),size=.5)+
    geom_vline(xintercept = 10, linetype="dashed", color = "gray", size=0.25)+
  scale_color_manual(values=c("#E69F00", "#56B4E9"))
d<-bp+geom_step(data=df%>%filter(G!=1,t>10),mapping=aes(x=t,y=ybar,colour=as.factor(G)),size=.5)+
    geom_vline(xintercept = 20, linetype="dashed", color = "gray", size=0.25)+
    scale_color_manual(values=c( "#E69F00", "#56B4E9"))

ggarrange(a,b,c,d,labels = c("DD1: Early (T) vs Never (C) ", "DD2: Late (T) vs Never (C)", "DD3: Early (T) vs Late (C) ","DD4: Late (T) vs Early (C)"),ncol = 4, nrow = 2,common.legend = TRUE, legend = "bottom", font.label = list(size = 3.5, face = "plain", color ="black"))
```



## GB: ${\beta}^{DD}$ is a weighted average of the separate DDs

- In our running example,  ${\beta}^{DD}$ is the weighted average across these 4 DDs:

\begin{equation}
\hat{\beta}_{fe}=w_1\hat{\beta}^{DD}_1+w_2\hat{\beta}^{DD}_2+w_3\hat{\beta}^{DD}_3+w_4\hat{\beta}^{DD}_4
\end{equation}

- Key insight: $w\neq$ population shares, but also depends on when a group gets treated. 

- See Theorem 1 in GB for the general expression of (3) (equation 10a in his paper) and the definition of the weights. 

- GB then shows that:

\begin{align}
\beta^{DD}=VWATT+VWCT-\Lambda ATT
\end{align}

where: 

- $VWATT$: variance weighted ATE.
- $VWCT$: variance weighted common trends.
- $\Delta ATT$ time varying treatment effect.
    
(see page 12 in Goodman-Bacon, 2019)

## Is it a problem? Let's consider an example.
**DGP**

- treatment effects: group2=1 (yellow), group3=2 (blue)
- equal group sizes
- **population weighted average  treatment effects=1.5**

```{r , echo = FALSE,include=FALSE}
dfnew<-simulate_data(42,10,20,1,2,0.05,0,30,30)
df_bacon <- bacon(y ~ D,data = df,id_var = "id",time_var = "t")    # Bacon decomp
cc<-felm(y ~ D | G+ t, df)
```

\vspace{15pt}
**Estimated effects**
\vspace{-10pt}
```{r , echo = FALSE, fig.width=5,fig.height=1.5, cache=TRUE,fig.align="center"}


bp<-ggplot(df)+theme_classic()+ theme(legend.position="top")+
  labs(x="t",y="y",colour="g") +xlim(0,50)+ylim(0,4)+
   theme(axis.ticks = element_blank(),plot.background = element_rect(fill="#FAFAFA",colour = "#FAFAFA"),axis.title.y =element_text(angle=0),
         text = element_text(size=4),legend.background = element_rect(fill="#FAFAFA",colour = "#FAFAFA"),plot.title = element_text(hjust = 0.5),
         panel.background = element_rect(fill = "#FAFAFA"),legend.margin=margin(b=-10),legend.box.margin=margin(0,0,0,0))
   

a<-bp+geom_step(data=df%>%filter(G!=3),mapping=aes(x=t,y=ybar,colour=as.factor(G)),size=.5)+
    geom_vline(xintercept = 10, linetype="dashed", color = "gray", size=0.25)+labs(title=paste("beta_DD1:",round(df_bacon$estimate[1],digits=2)))+
  scale_color_manual(values=c("#999999", "#E69F00", "#56B4E9"))+labs(y=paste("w_1:",round(df_bacon$weight[1],digits=2)))
b<-bp+geom_step(data=df%>%filter(G!=2),mapping=aes(x=t,y=ybar,colour=as.factor(G)),size=.5)+
    geom_vline(xintercept = 20, linetype="dashed", color = "gray", size=0.25)+labs(title=paste("beta_DD2:",round(df_bacon$estimate[2],digits=2)))+
     scale_color_manual(values=c("#999999",  "#56B4E9"))+labs(y=paste("w_2:",round(df_bacon$weight[2],digits=2)))
c<-bp+geom_step(data=df%>%filter(G!=1,t<20),mapping=aes(x=t,y=ybar,colour=as.factor(G)),size=.5)+
    geom_vline(xintercept = 10, linetype="dashed", color = "gray", size=0.25)+labs(title=paste("beta_DD3:",round(df_bacon$estimate[4],digits=2)))+
  scale_color_manual(values=c("#E69F00", "#56B4E9"))+labs(y=paste("w_3:",round(df_bacon$weight[4],digits=2)))
d<-bp+geom_step(data=df%>%filter(G!=1,t>10),mapping=aes(x=t,y=ybar,colour=as.factor(G)),size=.5)+
    geom_vline(xintercept = 20, linetype="dashed", color = "gray", size=0.25)+labs(title=paste("beta_DD4:",round(df_bacon$estimate[3],digits=2)))+
    scale_color_manual(values=c( "#E69F00", "#56B4E9"))+labs(y=paste("w_4:",round(df_bacon$weight[3],digits=2)))

ggarrange(a,b,c,d,nrow=1, common.legend = TRUE, legend="top")
```


- $\hat{\beta}_{fe}=$ `r round(df_bacon$weight[1],digits=2)` $\times$ `r round(df_bacon$estimate[1],digits=2)`+ 
                          `r round(df_bacon$weight[2],digits=2)` $\times$ `r round(df_bacon$estimate[2],digits=2)`+ 
                          `r round(df_bacon$weight[4],digits=2)` $\times$ `r round(df_bacon$estimate[4],digits=2)`+ 
                          `r round(df_bacon$weight[3],digits=2)` $\times$ `r round(df_bacon$estimate[3],digits=2)`=`r round(as.numeric(cc$coefficients[1]),digits=2)`

- Group 3 (blue) gets a higher weight because it is treated more in the middle.
- Not a problem if you know that it is not population weighted.

## What about the last term ($\Lambda ATT$)? Treatments effects varying over time.
**DGP**

- We now let the treatmetn effect grow with a rate of 3 percent per period in group 2
- **population weighted average  treatment effect=2.42**

```{r , echo = FALSE,include=FALSE}
dfnew<-simulate_data(42,10,20,1,2,0.05,0,30,30)
#dfplot<-dfnew%>%group_by(G,D)%>%mutate(ybar=mean(y))
df_bacon <- bacon(y ~ D,data = dfnew,id_var = "id",time_var = "t")    # Bacon decomp
cc<-felm(y ~ D | G+ t, dfnew)
```

```{r , echo = FALSE, fig.width=3.15,fig.height=2., cache=TRUE,fig.align="center",warning=FALSE}


dfplot<-dfnew%>%ungroup()%>%mutate(D=ifelse(t>=10&t<20&G==2,1,D))%>%group_by(G,D)%>%mutate(ybar=mean(y))


ggplot(dfplot)+geom_jitter(aes(x=t,y=y,colour=as.factor(G)),size=0.25,alpha=0.05)+theme_classic()+ theme(legend.position="top")+
  geom_step(aes(x=t,y=ybar,colour=as.factor(G)),size=1.25)+
  labs(x="t",y="y",colour="g") +scale_color_manual(values=c("#999999", "#E69F00", "#56B4E9"))+
  theme(axis.ticks = element_blank(),plot.background = element_rect(fill="#FAFAFA",colour = "#FAFAFA"),
        text = element_text(size=5),legend.background = element_rect(fill="#FAFAFA",colour = "#FAFAFA"),
        panel.background = element_rect(fill = "#FAFAFA"),legend.margin=margin(b=-10),legend.box.margin=margin(0,0,0,0))+
  geom_vline(xintercept = 10, linetype="dashed", color = "gray", size=0.5)+
  geom_vline(xintercept = 20, linetype="dashed", color = "gray", size=0.5)


```   

-  **BUT** $\hat{\beta}_{fe}=1.73$ 

  - That issmaller than the average treatment effect in any of the groups!
  
- Why?

## What about the last term ($\Lambda ATT$)? Treatments effects varying over time.

**DGP**

- We now let the treatmetn effect grow with a rate of 3 percent per period in group 2
- **population weighted average  treatment effect=2.42**

```{r , echo = FALSE,include=FALSE}
dfnew<-simulate_data(42,10,20,1,2,0.05,0,30,30)
df_bacon <- bacon(y ~ D,data = dfnew,id_var = "id",time_var = "t")    # Bacon decomp
cc<-felm(y ~ D | G+ t, dfnew)
```

\vspace{15pt}
**Decomposing the estimated effect using GBs approach**
\vspace{-10pt}
```{r , echo = FALSE, fig.width=5,fig.height=1.5, cache=TRUE,fig.align="center",warning=FALSE}
dfnew<-simulate_data(42,10,20,1,2,0.05,0,30,30)
dfplot<-dfnew%>%ungroup()%>%mutate(DD=ifelse(t>=10&t<20&G==2,3,D))%>%group_by(G,D)%>%mutate(ybar=mean(y))%>%
  group_by(G,DD)%>%mutate(ybar1=mean(y))
  



bp<-ggplot(dfplot)+theme_classic()+ theme(legend.position="top")+
  labs(x="t",y="y",colour="g") +xlim(0,50)+ylim(0,15)+
  theme(axis.ticks = element_blank(),plot.background = element_rect(fill="#FAFAFA",colour = "#FAFAFA"),axis.title.y =element_text(angle=0),
        text = element_text(size=4),legend.background = element_rect(fill="#FAFAFA",colour = "#FAFAFA"),plot.title = element_text(hjust = 0.5),
        panel.background = element_rect(fill = "#FAFAFA"),legend.margin=margin(b=-10),legend.box.margin=margin(0,0,0,0))
dfnew<-simulate_data(42,10,20,1,2,0.05,0,30,30)  
dfnew<-dfnew%>%group_by(t,G)%>%summarise(ybar=mean(y))


a<-bp+geom_step(data=dfplot%>%filter(G!=3),mapping=aes(x=t,y=ybar,colour=as.factor(G)),size=.5)+
  geom_jitter(data=dfplot%>%filter(G!=3),mapping=aes(x=t,y=y,colour=as.factor(G)),size=0.05,alpha=0.05)+
  geom_vline(xintercept = 10, linetype="dashed", color = "gray", size=0.25)+labs(title=paste("beta_DD1:",round(df_bacon$estimate[1],digits=2)))+
  scale_color_manual(values=c("#999999", "#E69F00", "#56B4E9"))+labs(y=paste("w_1:",round(df_bacon$weight[1],digits=2)))
b<-bp+geom_step(data=dfplot%>%filter(G!=2),mapping=aes(x=t,y=ybar,colour=as.factor(G)),size=.5)+
  geom_jitter(data=dfplot%>%filter(G!=2),mapping=aes(x=t,y=y,colour=as.factor(G)),size=0.05,alpha=0.05)+
  geom_vline(xintercept = 20, linetype="dashed", color = "gray", size=0.25)+labs(title=paste("beta_DD2:",round(df_bacon$estimate[2],digits=2)))+
  scale_color_manual(values=c("#999999",  "#56B4E9"))+labs(y=paste("w_2:",round(df_bacon$weight[2],digits=2)))
c<-bp+geom_step(data=dfplot%>%filter(G!=1,t<20),mapping=aes(x=t,y=ybar1,colour=as.factor(G)),size=.5)+
  geom_jitter(data=dfplot%>%filter(G!=1,t<20),mapping=aes(x=t,y=y,colour=as.factor(G)),size=0.05,alpha=0.05)+
  geom_vline(xintercept = 10, linetype="dashed", color = "gray", size=0.25)+labs(title=paste("beta_DD3:",round(df_bacon$estimate[4],digits=2)))+
  scale_color_manual(values=c("#E69F00", "#56B4E9"))+labs(y=paste("w_3:",round(df_bacon$weight[4],digits=2)))
d<-bp+geom_step(data=dfplot%>%filter(G!=1,t>10),mapping=aes(x=t,y=ybar1,colour=as.factor(G)),size=.5)+
  geom_jitter(data=dfplot%>%filter(G!=1,t>10),mapping=aes(x=t,y=y,colour=as.factor(G)),size=0.05,alpha=0.05)+
  geom_vline(xintercept = 20, linetype="dashed", color = "gray", size=0.25)+labs(title=paste("beta_DD4:",round(df_bacon$estimate[3],digits=2)))+
  scale_color_manual(values=c( "#E69F00", "#56B4E9"))+labs(y=paste("w_4:",round(df_bacon$weight[3],digits=2)))

ggarrange(a,b,c,d,nrow=1,common.legend = TRUE)

```   


- $\hat{\beta}_{fe}=$ `r round(df_bacon$weight[1],digits=2)` $\times$ `r round(df_bacon$estimate[1],digits=2)`+ 
                          `r round(df_bacon$weight[2],digits=2)` $\times$ `r round(df_bacon$estimate[2],digits=2)`+ 
                          `r round(df_bacon$weight[4],digits=2)` $\times$ `r round(df_bacon$estimate[4],digits=2)`+ 
                          `r round(df_bacon$weight[3],digits=2)` $\times$ `r round(df_bacon$estimate[3],digits=2)`=`r round(as.numeric(cc$coefficients[1]),digits=2)`


What if we left out the last DD?

- $\hat{\beta}_{fe}=$ `r round(df_bacon$weight[1],digits=2)` $\times$ `r round(df_bacon$estimate[1],digits=2)`+ 
                          `r round(df_bacon$weight[2],digits=2)` $\times$ `r round(df_bacon$estimate[2],digits=2)`+ 
                          `r round(df_bacon$weight[4],digits=2)` $\times$ `r round(df_bacon$estimate[4],digits=2)`=
                          `r round(df_bacon$weight[1]*df_bacon$estimate[1]+df_bacon$weight[2]*df_bacon$estimate[2]+df_bacon$weight[4]*df_bacon$estimate[4],digits=2)`

## GB Summary

*Goodman-Bacon (GB): "Difference-in-Differences with Variation in Treatment Timing" (2019, WP)*

**Take aways**

-  $\hat{\beta}_{fe}=$ is a weighted average of all the DDs possible combinations 

- Weights $\neq$ popualion shares, but depend on treatment timing. Groups that are treated towards the middle of the period receive more weight.

- If treatment effects vary over time, some DDs can be negative. 

- Also relevant for the common trend assumption: Violations can offset each other.

- GB derives test for violation of weighted common trend assumption.

**What we should do**

- Compute weights and DDs and check whether any of them are negative. ("bacondecomp" function in R and Stata).

- Test for violation of common trend assumption.

- Read the paper (there is much more than ocvered here)


## Now to the CD   decomposition
*Chaisemartin & D'Haultfoeuille (CD): "Two-way fixed effects estimators with heterogeneous treatment effects" (forthcoming, AER)*

**Decompose $\beta_{fe}$  in weighted TEs across  $(g,t):D_{g,t}=1$ cells**

- (back to the original example with constant treatment effects over time)

```{r , echo = FALSE,fig.width=4,fig.height=2,fig.align="center"}
df1<-simulate_data(42,10,20,1,2,0,0,30,30)
df1<-df1%>%group_by(G,t)%>%summarise(ybar=mean(ybar),D=mean(D))

ggplot(df1)+geom_step(aes(x=t,y=ybar,colour=as.factor(G)),size=1,alpha=0.15)+
  geom_step(df1%>%filter(G!=3),mapping=aes(x=t,y=ybar,colour=as.factor(G)),size=1)+
  theme_classic()+ theme(legend.position="top")+
  labs(x="t",y="y",colour="g") +scale_color_manual(values=c("#999999", "#E69F00", "#56B4E9"))+ylim(0,4)+
   theme(axis.ticks = element_blank(),plot.background = element_rect(fill="#FAFAFA",colour = "#FAFAFA"),
         text = element_text(size=5),legend.background = element_rect(fill="#FAFAFA",colour = "#FAFAFA"),
         panel.background = element_rect(fill = "#FAFAFA"),legend.margin=margin(b=-10),legend.box.margin=margin(0,0,0,0))+
   geom_vline(xintercept = 10, linetype="dashed", color = "gray", size=0.5)+
  geom_vline(xintercept = 20, linetype="dashed", color = "gray", size=0.5)

```

## The CD decomposition

*Chaisemartin & D'Haultfoeuille (CD): "Two-way fixed effects estimators with heterogeneous treatment effects" (forthcoming, AER)*

**Decompose $\beta_{fe}$  in weighted TEs across  $(g,t):D_{g,t}=1$ cells**

- i.e. for the cell $g=2,t=10$, weight number: 1

```{r , echo = FALSE,fig.width=4,fig.height=2,fig.align="center"}
ggplot(df1)+geom_step(aes(x=t,y=ybar,colour=as.factor(G)),size=1,alpha=0.15)+
  geom_step(df1%>%filter(G!=3),mapping=aes(x=t,y=ybar,colour=as.factor(G)),size=1)+
  theme_classic()+ theme(legend.position="top")+
  labs(x="t",y="y",colour="g") +scale_color_manual(values=c("#999999", "#E69F00", "#56B4E9"))+ylim(0,4)+
   theme(axis.ticks = element_blank(),plot.background = element_rect(fill="#FAFAFA",colour = "#FAFAFA"),
         text = element_text(size=5),legend.background = element_rect(fill="#FAFAFA",colour = "#FAFAFA"),
         panel.background = element_rect(fill = "#FAFAFA"),legend.margin=margin(b=-10),legend.box.margin=margin(0,0,0,0))+
   geom_vline(xintercept = 10, linetype="dashed", color = "gray", size=0.5)+
  geom_vline(xintercept = 20, linetype="dashed", color = "gray", size=0.5)+
    geom_point(data=df1%>%filter(t==10&G==2),mapping=aes(x=t,y=ybar,colour=as.factor(G)))+
  geom_text(aes(x=10,y=2.3),label="(g=2,t=10)", size=2)
```

## The CD decomposition

*Chaisemartin & D'Haultfoeuille (CD): "Two-way fixed effects estimators with heterogeneous treatment effects" (forthcoming, AER)*

**Decompose $\beta_{fe}$  in weighted TEs across  $(g,t):D_{g,t}=1$ cells**

- i.e. for the cell $g=2,t=11$, weight number: 2

```{r , echo = FALSE,fig.width=4,fig.height=2,fig.align="center"}
ggplot(df1)+geom_step(aes(x=t,y=ybar,colour=as.factor(G)),size=1,alpha=0.15)+
  geom_step(df1%>%filter(G!=3),mapping=aes(x=t,y=ybar,colour=as.factor(G)),size=1)+
  theme_classic()+ theme(legend.position="top")+
  labs(x="t",y="y",colour="g") +scale_color_manual(values=c("#999999", "#E69F00", "#56B4E9"))+ylim(0,4)+
   theme(axis.ticks = element_blank(),plot.background = element_rect(fill="#FAFAFA",colour = "#FAFAFA"),
         text = element_text(size=5),legend.background = element_rect(fill="#FAFAFA",colour = "#FAFAFA"),
         panel.background = element_rect(fill = "#FAFAFA"),legend.margin=margin(b=-10),legend.box.margin=margin(0,0,0,0))+
   geom_vline(xintercept = 10, linetype="dashed", color = "gray", size=0.5)+
  geom_vline(xintercept = 20, linetype="dashed", color = "gray", size=0.5)+
    geom_point(data=df1%>%filter(t==10&G==2),mapping=aes(x=t,y=ybar,colour=as.factor(G)),alpha=.25)+
    geom_point(data=df1%>%filter(t==11&G==2),mapping=aes(x=t,y=ybar,colour=as.factor(G)))+
  geom_text(aes(x=11,y=2.3),label="(g=2,t=11)",size=2)
  
```

## The CD decomposition

*Chaisemartin & D'Haultfoeuille (CD): "Two-way fixed effects estimators with heterogeneous treatment effects" (forthcoming, AER)*

**Decompose $\beta_{fe}$  in weighted TEs across  $(g,t):D_{g,t}=1$ cells**

- i.e. for the cell $g=2,t=12$, weight number: 3

```{r , echo = FALSE,fig.width=4,fig.height=2,fig.align="center"}
ggplot(df1)+geom_step(aes(x=t,y=ybar,colour=as.factor(G)),size=1,alpha=0.15)+
  geom_step(df1%>%filter(G!=3),mapping=aes(x=t,y=ybar,colour=as.factor(G)),size=1)+
  theme_classic()+ theme(legend.position="top")+
  labs(x="t",y="y",colour="g") +scale_color_manual(values=c("#999999", "#E69F00", "#56B4E9"))+ylim(0,4)+
   theme(axis.ticks = element_blank(),plot.background = element_rect(fill="#FAFAFA",colour = "#FAFAFA"),
         text = element_text(size=5),legend.background = element_rect(fill="#FAFAFA",colour = "#FAFAFA"),
         panel.background = element_rect(fill = "#FAFAFA"),legend.margin=margin(b=-10),legend.box.margin=margin(0,0,0,0))+
   geom_vline(xintercept = 10, linetype="dashed", color = "gray", size=0.5)+
  geom_vline(xintercept = 20, linetype="dashed", color = "gray", size=0.5)+
    geom_point(data=df1%>%filter(t%in%10:11&G==2),mapping=aes(x=t,y=ybar,colour=as.factor(G)),alpha=.25)+
    geom_point(data=df1%>%filter(t==12&G==2),mapping=aes(x=t,y=ybar,colour=as.factor(G)))+
  geom_text(aes(x=12,y=2.3),label="(g=2,t=12)",size=2)
  
```

## The CD decomposition

*Chaisemartin & D'Haultfoeuille (CD): "Two-way fixed effects estimators with heterogeneous treatment effects" (forthcoming, AER)*

**Decompose $\beta_{fe}$  in weighted TEs across  $(g,t):D_{g,t}=1$ cells**

- i.e. for the cell $g=2,t=13$, weight number: 4

```{r , echo = FALSE,fig.width=4,fig.height=2,fig.align="center"}
ggplot(df1)+geom_step(aes(x=t,y=ybar,colour=as.factor(G)),size=1,alpha=0.15)+
  geom_step(df1%>%filter(G!=3),mapping=aes(x=t,y=ybar,colour=as.factor(G)),size=1)+
  theme_classic()+ theme(legend.position="top")+
  labs(x="t",y="y",colour="g") +scale_color_manual(values=c("#999999", "#E69F00", "#56B4E9"))+ylim(0,4)+
   theme(axis.ticks = element_blank(),plot.background = element_rect(fill="#FAFAFA",colour = "#FAFAFA"),
         text = element_text(size=5),legend.background = element_rect(fill="#FAFAFA",colour = "#FAFAFA"),
         panel.background = element_rect(fill = "#FAFAFA"),legend.margin=margin(b=-10),legend.box.margin=margin(0,0,0,0))+
   geom_vline(xintercept = 10, linetype="dashed", color = "gray", size=0.5)+
  geom_vline(xintercept = 20, linetype="dashed", color = "gray", size=0.5)+
    geom_point(data=df1%>%filter(t%in%10:12&G==2),mapping=aes(x=t,y=ybar,colour=as.factor(G)),alpha=.25)+
    geom_point(data=df1%>%filter(t==13&G==2),mapping=aes(x=t,y=ybar,colour=as.factor(G)))+
  geom_text(aes(x=13,y=2.3),label="(g=2,t=13)",size=2)
  
  
```

## The CD decomposition

*Chaisemartin & D'Haultfoeuille (CD): "Two-way fixed effects estimators with heterogeneous treatment effects" (forthcoming, AER)*

**Decompose $\beta_{fe}$  in weighted TEs across  $(g,t):D_{g,t}=1$ cells**

- i.e. for the cell $g=3,t=50$, weight number: 72

```{r , echo = FALSE,fig.width=4,fig.height=2,fig.align="center"}
ggplot(df1)+geom_step(aes(x=t,y=ybar,colour=as.factor(G)),size=1,alpha=0.15)+
  geom_step(df1,mapping=aes(x=t,y=ybar,colour=as.factor(G)),size=1)+
  theme_classic()+ theme(legend.position="top")+
  labs(x="t",y="y",colour="g") +scale_color_manual(values=c("#999999", "#E69F00", "#56B4E9"))+ylim(0,4)+
   theme(axis.ticks = element_blank(),plot.background = element_rect(fill="#FAFAFA",colour = "#FAFAFA"),
         text = element_text(size=5),legend.background = element_rect(fill="#FAFAFA",colour = "#FAFAFA"),
         panel.background = element_rect(fill = "#FAFAFA"),legend.margin=margin(b=-10),legend.box.margin=margin(0,0,0,0))+
   geom_vline(xintercept = 10, linetype="dashed", color = "gray", size=0.5)+
  geom_vline(xintercept = 20, linetype="dashed", color = "gray", size=0.5)+
    geom_point(data=df1%>%filter(D==1),mapping=aes(x=t,y=ybar,colour=as.factor(G)),alpha=.25)+
    geom_point(data=df1%>%filter(t==50&G==3),mapping=aes(x=t,y=ybar,colour=as.factor(G)))+
  geom_text(aes(x=50,y=3.3),label="(g=3,t=50)",size=2)
  
  
```

## The CD decomposition

**Decompose $\beta_{fe}$  in weighted TEs across  $(g,t):D_{g,t}=1$ cells**

- $\beta_{fe}$ is then given by

\begin{align}
\beta_{fe}=E\left[\sum_{(g,t):D_{g,t}=1} \frac{N_{g,t}}{N_{D=1}} w_{g,t}\Lambda_{g,t}\right]
\end{align}


where

- $w_{g,t}$ is the weight on group $g$ in period $t$ 
- $\Lambda_{g,t}$ is the TE in group $g$ in period $t$
- $N_{D=1}$ is the number of treated units.
- $N_{g,t}$ is the number of observations in cell $g$ and $t$. 
\vspace{12pt}

**See Theorem 1 in CD**

- How are the weights defined?

## CD: Calculating the weights

**Calculating the CD weights**

1. Run a regression of $D_{g,t}$ on a constant, $g$ and $t$ fixed effects.
2. Save the residual, $e_{fe,g,t}$
3. Create the weight of that cell as

\begin{align}
w_{fe,g_t}=\frac{e_{fe,g,t}}{\sum_{(g,t):D_{g,t}=1} \frac{N_{g,t}}{N_{D=1}}e_{fe,g,t}}
\end{align}


**Intuition**

- Consider cell $(g,t)$ from a group that is treated for almost the entire period and at a time where almost all cells are treated. 
- We would predict that this cell is treated (because it is from a group that is mostly treated at a time that is mostly treated). 
- $\Rightarrow$ small or even negative residual 
- $\Rightarrow$ small or even negative weight.


 
## An  example from CD

- 2 equally sized groups, 3 periods
  - group 1 is only treated in period 3
  - group 2 is treated in period 2 and 3
  \vspace{12pt}
- The weights are then:
  - $e_{fe,1,3}=1/6$
  - $e_{fe,2,2}=2/6$
  - $e_{fe,2,3}=-1/6$
  
  \vspace{12pt}
- So that  $\beta_{fe}=1/2 \times E(\Lambda_{1,3}) + 1\times E(\Lambda_{2,2}) - 1/2 \times E(\Lambda_{2,3})$
- If for example $E(\Lambda_{2,3})=4$ & $E(\Lambda_{1,3})=E(\Lambda_{2,2})=1$, then $\beta_{fe}=-1/2$
- Estimate is negative, although all cell's treatment effects are positive!
- This is only an issue with heterogenous treatment effects. 



## Let's calculate the weights in our example

```{r , echo = FALSE,fig.width=3.5,fig.height=2,fig.align="center",warning=FALSE}
rm(list=ls())
# Simulate data
simulate_data<-function(seed,T2,T3,m2,m3,mt2,mt3,G2,G3){
  # set values
  set.seed(seed)                        # set seed
  mt2=(1+mt2)                           # Treatment effect growth group 2
  mt3=(1+mt3)                           # Treatment effect growth group 3
  m2=1+m2                               # Treatment effect group 2
  m3=1+m3                               # Treatment effect group 3
  T<-50                                 # Time periods
  G<-3                                  # Groups
  G1<-30                                # Group size group 1 (never treated)
  N<-G1+G2+G3   
  # Create tibble
  df<-tibble(id=rep(1:(N),T),                                     # Id variable 1 2 3 ... 1 2 3 
             t=rep(1:T,each=(N)))%>%                              # Time variable 1 1 1 1 .... 2 2 2
      mutate(G=ifelse(id<=G1,1,ifelse(id>G1&id<=(G1+G2),2,3)),    # Treated: D==1
             D=ifelse(G==2&t>=T2,1,ifelse(G==3&t>=T3,1,0)),         # Post treatment indicator 
             mean=ifelse(D==1&G==2,m2*mt2^(t-T2),                 # Treatment effect group 2 
                  ifelse(D==1&G==3,m3*mt3^(t-T3),                 # Treatment effect group 3
                              1)),                                # mean Y for untreated
              y=rnorm(n=N*T,mean=mean,sd=.1))%>%                  # Simulate Outcome y
    group_by(G,D)%>%                                              # Group by "group times post" treatment
    mutate(ybar=mean(y))                                          # Group means for chart
  return(df)
}
df1<-simulate_data(42,10,20,1,2,0,0,30,30)

m<-lm(D~as.factor(t)+as.factor(G),data=df1)
df1$res<-m$residuals
# calculate weights
w<-df1%>%filter(G!=1)%>%group_by(t,G)%>%summarise(d=mean(D),res=mean(res))%>%filter(d==1)%>%
   ungroup()%>%mutate(weight=1/72*res/sum((1/72)*res),y=ifelse(G==2,2,ifelse(G==3,3,NA)))
# charts
ggplot(df1)+geom_step(aes(x=t,y=ybar,colour=as.factor(G)))+
  scale_color_manual(values=c("#999999", "#E69F00", "#56B4E9"))+
  theme_classic()+ theme(legend.position="top")+
  labs(x="t",y="y",colour="g") +ylim(0,4)+
  theme(axis.ticks = element_blank(),plot.background = element_rect(fill="#FAFAFA",colour = "#FAFAFA"),
        text = element_text(size=5),legend.background = element_rect(fill="#FAFAFA",colour = "#FAFAFA"),
        panel.background = element_rect(fill = "#FAFAFA"),legend.margin=margin(b=-10),legend.box.margin=margin(0,0,0,0))+
  geom_vline(xintercept = 10, linetype="dashed", color = "gray", size=0.5)+
  geom_vline(xintercept = 20, linetype="dashed", color = "gray", size=0.5)+
  geom_point(data=w,mapping=aes(x=t,y=y,shape=as.factor(round(weight,digits=6))),size=1)+labs(colour="g",shape="weight")
  
  
  
```
\vspace{-10pt}
- Largest weight at the beginning: few groups are treated.
- Group 2 cells even get  negative weight after $t=20$ because they are from a group that is mostly treated and at a time that that is mostly treated.

**And using equation (5) we get**:

- $\hat{\beta}_{fe}$=10 $\times$ 0.03608 $\times$ 1+
                      31 $\times$ 0.02135 $\times$ 2-
                      31 $\times$ 0.0007361 $\times$ 1=1.66
                      
- Note: the cells' TEs are normally unobserved (we know the DGP).

##  Can we link the CD and GB weights?

**The GB weights**
\vspace{-15pt}
```{r , echo = FALSE, include=FALSE}
rm(df1,df)
df1<-simulate_data(42,10,20,1,2,0,0,30,30)
df_bacon <- bacon(y ~ D,data = df1,id_var = "id",time_var = "t")   

``` 
```{r , echo = FALSE, fig.width=5,fig.height=1.5, cache=TRUE,fig.align="center"}
bp<-ggplot(df1)+theme_classic()+ theme(legend.position="top")+
  labs(x="t",y="y",colour="g") +xlim(0,50)+ylim(0,4)+
   theme(axis.ticks = element_blank(),plot.background = element_rect(fill="#FAFAFA",colour = "#FAFAFA"),axis.title.y =element_text(angle=0),
         text = element_text(size=4),legend.background = element_rect(fill="#FAFAFA",colour = "#FAFAFA"),plot.title = element_text(hjust = 0.5),
         panel.background = element_rect(fill = "#FAFAFA"),legend.margin=margin(b=-10),legend.box.margin=margin(0,0,0,0))
   

a1<-bp+geom_step(data=df1%>%filter(G!=3),mapping=aes(x=t,y=ybar,colour=as.factor(G)),size=.5)+
    geom_vline(xintercept = 10, linetype="dashed", color = "gray", size=0.25)+labs(title=paste("beta_DD1:",round(df_bacon$estimate[1],digits=2)))+
  scale_color_manual(values=c("#999999", "#E69F00", "#56B4E9"))+labs(title=paste("w_1:",round(df_bacon$weight[1],digits=2)))
b1<-bp+geom_step(data=df1%>%filter(G!=2),mapping=aes(x=t,y=ybar,colour=as.factor(G)),size=.5)+
    geom_vline(xintercept = 25, linetype="dashed", color = "gray", size=0.25)+labs(title=paste("beta_DD2:",round(df_bacon$estimate[2],digits=2)))+
     scale_color_manual(values=c("#999999",  "#56B4E9"))+labs(title=paste("w_2:",round(df_bacon$weight[2],digits=2)))
c1<-bp+geom_step(data=df1%>%filter(G!=1,t<20),mapping=aes(x=t,y=ybar,colour=as.factor(G)),size=.5)+
    geom_vline(xintercept = 10, linetype="dashed", color = "gray", size=0.25)+labs(title=paste("beta_DD3:",round(df_bacon$estimate[4],digits=2)))+
  scale_color_manual(values=c("#E69F00", "#56B4E9"))+labs(title=paste("w_3:",round(df_bacon$weight[4],digits=2)))
d1<-bp+geom_step(data=df1%>%filter(G!=1,t>10),mapping=aes(x=t,y=ybar,colour=as.factor(G)),size=.5)+
    geom_vline(xintercept = 25, linetype="dashed", color = "gray", size=0.25)+labs(title=paste("beta_DD4:",round(df_bacon$estimate[3],digits=2)))+
    scale_color_manual(values=c( "#E69F00", "#56B4E9"))+labs(title=paste("w_4:",round(df_bacon$weight[3],digits=2)))

ggarrange(a1,b1,c1,d1,nrow=1, common.legend = TRUE, legend="top")

```   
\vspace{-13pt}

- Sum of weights where G=2 is treated: 0.27+0.07=0.34 
- Sum of weights where G=3 is treated: 0.43+0.23= 0.66


**The CD weights**
\vspace{-18pt}

```{r , echo = FALSE, fig.width=2.5,fig.height=1.5, cache=TRUE,fig.align="center",warning=FALSE}
rm(list=ls())
# Simulate data
simulate_data<-function(seed,T2,T3,m2,m3,mt2,mt3,G2,G3){
  # set values
  set.seed(seed)                        # set seed
  mt2=(1+mt2)                           # Treatment effect growth group 2
  mt3=(1+mt3)                           # Treatment effect growth group 3
  m2=1+m2                               # Treatment effect group 2
  m3=1+m3                               # Treatment effect group 3
  T<-50                                 # Time periods
  G<-3                                  # Groups
  G1<-30                                # Group size group 1 (never treated)
  N<-G1+G2+G3   
  # Create tibble
  df<-tibble(id=rep(1:(N),T),                                     # Id variable 1 2 3 ... 1 2 3 
             t=rep(1:T,each=(N)))%>%                              # Time variable 1 1 1 1 .... 2 2 2
      mutate(G=ifelse(id<=G1,1,ifelse(id>G1&id<=(G1+G2),2,3)),    # Treated: D==1
             D=ifelse(G==2&t>=T2,1,ifelse(G==3&t>=T3,1,0)),         # Post treatment indicator 
             mean=ifelse(D==1&G==2,m2*mt2^(t-T2),                 # Treatment effect group 2 
                  ifelse(D==1&G==3,m3*mt3^(t-T3),                 # Treatment effect group 3
                              1)),                                # mean Y for untreated
              y=rnorm(n=N*T,mean=mean,sd=.1))%>%                  # Simulate Outcome y
    group_by(G,D)%>%                                              # Group by "group times post" treatment
    mutate(ybar=mean(y))                                          # Group means for chart
  return(df)
}
df1<-simulate_data(42,10,20,1,2,0,0,30,30)

m<-lm(D~as.factor(t)+as.factor(G),data=df1)
df1$res<-m$residuals
# calculate weights
w<-df1%>%filter(G!=1)%>%group_by(t,G)%>%summarise(d=mean(D),res=mean(res))%>%filter(d==1)%>%
   ungroup()%>%mutate(weight=1/72*res/sum((1/72)*res),y=ifelse(G==2,2,ifelse(G==3,3,NA)))
# charts
ggplot(df1)+geom_step(aes(x=t,y=ybar,colour=as.factor(G)))+
  scale_color_manual(values=c("#999999", "#E69F00", "#56B4E9"))+
  theme_classic()+ theme(legend.position="top")+
  labs(x="t",y="y",colour="g") +ylim(0,4)+
  theme(axis.ticks = element_blank(),plot.background = element_rect(fill="#FAFAFA",colour = "#FAFAFA"),
        text = element_text(size=4),legend.background = element_rect(fill="#FAFAFA",colour = "#FAFAFA"),
        panel.background = element_rect(fill = "#FAFAFA"),legend.margin=margin(b=-10),legend.box.margin=margin(0,0,0,0))+
  geom_vline(xintercept = 10, linetype="dashed", color = "gray", size=0.35)+
  geom_vline(xintercept = 20, linetype="dashed", color = "gray", size=0.35)+
  geom_point(data=w,mapping=aes(x=t,y=y,shape=as.factor(round(weight,digits=6))),size=.8)+labs(colour="g",shape="weight")
  
  
  
```
\vspace{-13pt}

- Sum of weights where G=2 is treated: 10 $\times$ 0.03608 -31 $\times$ 0.0007361=0.34
- Sum of weights where G=3 is treated: 31 $\times$ 0.02135=0.66.


##  Back to CD

**So what should we do?**

1. Calculate weights of the cells!
2. If you have negative weights: calculate $\underline{\sigma}_{fe}$ (See Corollary 1 in the paper)
  - tells us the amount of treatment heterogeneity that is required to for the pop weighted average treatment effect to  have the opposite sign of $\hat{\beta}_{fe}$. 
  - So if $\underline{\sigma}_{fe}$ is very small you should be worried!
  - Are treatment effects likely to be correlated with weights? Check if weights are correlated with covariates.
3. If things still look bad: use their new estimator: $DID_M$
  - Identies average effect across switching cells:
  \begin{align}
  DID_M=\sigma^T_{t=2}\left(\overbrace{\frac{N_{1,0,t}}{N_S}DID_{+,t}}^{\text{"joiners"}}+\overbrace{\frac{N_{0,1,t}}{N_S}DID_{-,t}}^{\text{"leavers"}} \right)
  \end{align}
4. In Stata
- \texttt{twowayfeweights} calculates weights and $\underline{\sigma}_{fe}$

- \texttt{did\_multiplegt} estimates $DID_M$

- R is on the way

##  Read!

Read both papers. There are many more insights  in the papers. 

- Check assumptions!

- Adding controls

- First differences

- Placebo tests

- Correlation between weights and covariates

... and much more

## Summary 

Question: What is  $\hat{\beta}_{fe}$ from OLS regression of: 
$$ y_{i,g,t}=\alpha+\gamma' G_{g}+\psi' T_{t}+ \beta_{fe} D_{g,t}+e_{i,g,t}$$
capturing?

- Goodman-Bacon (2019, WP) shows that in a staggered adoptation design we can think of this as a weighted average of all possible difference-in-differences.
  - Weights are not equal to population weights, but depend on when units become treated!
  - Has implications for common trend assumption.
  - DDs might enter with opposite sign if treatment effect varies over time.
\vspace{12pt}  
  
  
- Chaisemartin & D'Haultfoeuille (forthcoming, AER) show that $\hat{\beta}_{fe}$ is a weighted average across all treated $(g,t)$ cells.
  - The weights can be negative and bias estimates when TEs are heterogeneous!
  - Provides a quantification of the degree of TE heterogeneity required in order to flip the sign. 
  - Provides a new estimator.
  - And much more.
  
  
## What I will do now

1. Calculate Chaisemartin & D'Haultfoeuille weights (with \texttt{twowayfeweights} in Stata or manually  in R).
2. If I have negative weights, I'll check how much treatment heterogeneity is required to flip the sign (with \texttt{did\_multiplegt} in Stata).
3. If 2. is small and  it is meaningful, I'll apply their new estimator.
  - Note it only identifies from switching cells!
4. If I have a staggered adoption design: check for negative DDs using GB approach (using \texttt{bacondecomp} in Stata).
5. Create event study charts if possible. 
6. Use new toolbox to check placebo effects/ weighted common trend assumptions.

  
  
## Thanks

Thanks to Clément, Xavier & Andrew for excellent papers!

